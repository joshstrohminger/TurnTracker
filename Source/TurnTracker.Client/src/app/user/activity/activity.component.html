<div *ngIf="activity" id="activity-wrapper">
  <mat-card>
    <mat-card-header>
      <mat-card-title>{{activity.name}}</mat-card-title>
      <mat-card-subtitle>
        <span *ngIf="activity.periodCount && activity.periodUnit; else noPeriod">{{activity.periodCount}} {{units[activity.periodUnit]}}{{activity.periodCount > 1 ? 's' : ''}}</span>
        <ng-template #noPeriod>indefinite</ng-template>
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <app-timer *ngIf="activity.dueDate" [due]="activity.dueDate"></app-timer>
      <table mat-table [dataSource]="activity.participants" class="padded">
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Person</th>
          <td mat-cell *matCellDef="let participant" [ngClass]="{'accent': participant.userId === myUserId, 'primary': participant.userId === activity.currentTurnUserId, 'warn': participant.userId === activity.currentTurnUserId && activity.overdue}">{{participant.name}}</td>
        </ng-container>
        <ng-container matColumnDef="turnsNeeded">
          <th mat-header-cell *matHeaderCellDef>Needed</th>
          <td mat-cell *matCellDef="let participant">{{participant.turnsNeeded}}</td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="['name','turnsNeeded']"></tr>
        <tr mat-row *matRowDef="let participant; columns: ['name','turnsNeeded']"></tr>
      </table>
    </mat-card-content>
  </mat-card>
  <mat-expansion-panel>
    <mat-expansion-panel-header>
      <mat-panel-title>Notifications</mat-panel-title>
    </mat-expansion-panel-header>
    <table mat-table [dataSource]="notifications" id="notifications">
      <ng-container matColumnDef="type">
        <th mat-header-cell *matHeaderCellDef>Type</th>
        <td mat-cell *matCellDef="let note">{{note.type | notification}}</td>
      </ng-container>
      <ng-container matColumnDef="sms">
        <th mat-header-cell *matHeaderCellDef class="center">SMS</th>
        <td mat-cell *matCellDef="let note">
          <mat-checkbox [(ngModel)]="note.sms" (change)="saveNotificationSetting(note)"></mat-checkbox>
        </td>
      </ng-container>
      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef class="center">E-Mail</th>
        <td mat-cell *matCellDef="let note">
          <mat-checkbox [(ngModel)]="note.email" (change)="saveNotificationSetting(note)"></mat-checkbox>
        </td>
      </ng-container>
      <ng-container matColumnDef="push">
        <th mat-header-cell *matHeaderCellDef class="center">Push</th>
        <td mat-cell *matCellDef="let note">
          <mat-checkbox [(ngModel)]="note.push" (change)="saveNotificationSetting(note)"></mat-checkbox>
        </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="['type','sms','email','push']"></tr>
      <tr mat-row *matRowDef="let note; columns: ['type','sms','email','push']"></tr>
    </table>
  </mat-expansion-panel>
  <mat-expansion-panel (opened)="loadTurns()">
    <mat-expansion-panel-header>
      <mat-panel-title>Turns</mat-panel-title>
    </mat-expansion-panel-header>
    <div *ngIf="hasTurns; else loadingTurns">
      <div class="positioning-wrapper">
        <mat-slide-toggle (change)="filterTurns($event.checked)" [disabled]="busy" id="disabled-toggle">Show Disabled</mat-slide-toggle>
        <table mat-table [dataSource]="turns" class="padded">
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef style="padding-left: 0.5em">Person</th>
            <td mat-cell *matCellDef="let turn" style="padding-left: 0.5em" [ngClass]="{'accent': turn.userId === myUserId}">{{names.get(turn.userId)}}</td>
          </ng-container>
          <ng-container matColumnDef="occurred">
            <th mat-header-cell *matHeaderCellDef>Occurred</th>
            <td mat-cell *matCellDef="let turn">{{turn.occurred | date: 'short'}}</td>
          </ng-container>
          <ng-container matColumnDef="gift">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let turn"><mat-icon *ngIf="turn.userId !== turn.creatorId">cake</mat-icon></td>
          </ng-container>
          <ng-container matColumnDef="options">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let turn" style="padding-right: 0">
              <button mat-icon-button [disabled]="busy" [matMenuTriggerFor]="optionsMenu" [matMenuTriggerData]="{turn: turn}" aria-label="Options">
                <mat-icon>more_vert</mat-icon>
              </button>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="['name','occurred','gift','options']"></tr>
          <tr mat-row *matRowDef="let turn; columns: ['name','occurred','gift','options']" [class.disabled]="turn.isDisabled"></tr>
        </table>
      </div>
    </div>
    <ng-template #loadingTurns>
      <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
    </ng-template>
    <mat-menu #optionsMenu="matMenu">
      <ng-template matMenuContent let-turn="turn">
        <button mat-menu-item (click)="toggleTurnDisabled(turn)" [disabled]="busy">
          <div *ngIf="turn.isDisabled; else enableButton">
            <mat-icon color="warn">add_circle_outline</mat-icon>
            <span>Enable Turn</span>
          </div>
        </button>
        <ng-template #enableButton>
          <div>
            <mat-icon color="warn">remove_circle_outline</mat-icon>
            <span>Disable Turn</span>
          </div>
        </ng-template>
      </ng-template>
    </mat-menu>
  </mat-expansion-panel>
  <div id="bottom-fab-container">
    <button mat-fab color="primary" (click)="takeTurn()" matTooltip="Take Turn" matTooltipPosition="before" [disabled]="busy"><mat-icon>add</mat-icon></button>
    <button mat-mini-fab color="accent" (click)="takeTurnWithOptions()" matTooltip="Take Turn With Options" matTooltipPosition="before" [disabled]="busy"><mat-icon>date_range</mat-icon></button>
  </div>
</div>
